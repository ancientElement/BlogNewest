---
title: 堆空间和栈空间
date: 2023-10-05T22:47:00
tags:
  - 随手记
  - 所想
  - 堆
  - 栈
---
## 栈

在C#中，每个**线程**都有自己的**栈空间**，栈空间的大小取决于操作系统和编译器的限制。一般来说，**32位**操作系统的栈空间大小约为**1MB到4MB**，**64位**操作系统的栈空间大小通常更大一些，大约在**1MB到8MB**之间。

**栈**：只要栈的**剩余空间**大于所申请空间，系统将为程序提供内存，否则将报异常提示**栈溢出**。

## 栈溢出异常

原因一个是临时变量过多，另外一个是死循环。

## 堆

**堆**：首先应该知道操作系统有一个**记录空闲内存地址**的链表，当系统收到程序的申请时，  
会遍历该链表，寻找第一个**空间大于**所申请空间的堆结点，然后将该结点从空闲结点链表  
中删除，并将该结点的空间**分配**给程序。

另外，对于大多数系统，会在这块内存空间中的**首地址**处记录本次**分配的大小**，这样，代码中的`delete`语句才能正确的**释放**本内存空间。

另外，由于找到的堆结点的大小不一定正好等于**申请的大小**，系统会自动的将多余的那部  
分重新放入空闲链表中。

## 区别

堆（heap）和栈（stack）是计算机内存中两种不同的内存分配方式，它们有以下主要区别：

1. **分配方式**：
   - 栈：栈是一种**自动分配**和**释放**内存的数据结构，存储在栈中的数据是按照**后进先出**（LIFO）的顺序存储和访问的。当你定义一个变量时，它会自动分配内存并且在该变量的**作用域结束**时自动释放内存。
   - 堆：堆是一种**动态分配**和**释放**内存的数据结构，它允许你在**运行**时分配和释放内存。堆中的数据是**无序**存储的，并且需要**手动管理**内存的分配和释放。

2. **分配速度**：
   - 栈：栈上的内存分配和释放是非常**快速**的，因为它是在编译时**静态分配**的。
   - 堆：堆上的内存分配和释放**相对较慢**，因为它是在运行时动态分配的。

3. **内存管理**：
   - 栈：栈上的内存分配和释放是由编译器**自动管理**的，**无需**手动干预。变量的生命周期与其**作用域**相对应，当变量离开作用域时，其所占用的内存会**自动**被释放。
   - 堆：堆上的内存分配和释放需要显式地进行管理。在动态分配内存时，需要手动调用 `new` 操作符来**分配内存**，并且在不需要使用内存时，需要手动调用 `delete` 操作符来释放内存，否则会导致**内存泄漏**。

4. **内存分配方式**：
   - 栈：栈上的内存分配是**连续的**，以固定的大小分配内存。栈的大小在程序启动时就确定了，因此栈的**大小是固定**的。
   - 堆：堆上的内存分配是**不连续的**，内存的分配和释放顺序是不确定的。堆的大小在程序运行时是**动态变化**的，取决于当前系统的可用内存大小。

总的来说

栈主要用于存储**局部变量**和函数调用的**上下文信息**，它的内存分配和释放由编译器**自动管理**

堆主要用于存储**动态分配**的内存和对象，需要**手动管理**内存的分配和释放，具有更大的灵活性和更高的开销。
